<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>NeuroStack — Weekly Brain Enhancement</title>
<style>
:root{
  --bg:#0b1220; --ink:#e5e7eb; --sub:#9ca3af; --card:#111827; --ring:#1f2937;
  --accent:#22d3ee; --accent2:#60a5fa; --ok:#34d399; --warn:#f59e0b; --bad:#ef4444;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f8fafc; --ink:#0f172a; --sub:#475569; --card:#ffffff; --ring:#e2e8f0;
    --accent:#0891b2; --accent2:#2563eb; --ok:#059669; --warn:#d97706; --bad:#dc2626;
  }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font:16px/1.55 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,system-ui,Arial;
  color:var(--ink); background:linear-gradient(180deg,var(--bg),#0b1220 520px);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{color:inherit}
header{
  position:sticky; top:0; z-index:50;
  background:linear-gradient(180deg,rgba(11,18,32,.95),rgba(11,18,32,.7));
  border-bottom:1px solid var(--ring); backdrop-filter:saturate(140%) blur(8px);
}
.wrap{max-width:1000px;margin:0 auto;padding:14px 16px}
.title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.logo{width:40px;height:40px;display:grid;place-items:center;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;font-weight:800}
h1{font-size:20px;margin:0}
.nav{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-top:10px}
.nav button{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--ink);
  border-radius:10px;padding:10px 6px;font-weight:700;letter-spacing:.2px}
.nav button.active{outline:2px solid var(--accent);border-color:transparent}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--ink);
  padding:9px 12px;border-radius:12px;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#0b1220}
.btn.ghost{background:transparent}
.btn.ok{border-color:var(--ok);color:var(--ok)}
.btn.warn{border-color:var(--warn);color:var(--warn)}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--ring);color:var(--sub)}
.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;margin-top:16px}
@media (max-width:930px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px;
  box-shadow:0 10px 24px rgba(0,0,0,.18)}
h2{font-size:16px;margin:0 0 8px 0}
h3{font-size:14px;margin:16px 0 8px 0;color:var(--sub)}
.meta p{margin:6px 0;color:var(--sub)}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--ring);color:var(--ink);font-size:12px}
section.day{margin-top:16px}
details summary{cursor:pointer;list-style:none}
details summary::-webkit-details-marker{display:none}
.details-pane{border:1px solid var(--ring);border-radius:12px;padding:10px;margin:8px 0;background:rgba(255,255,255,.02)}
.checks .row{display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;
  padding:10px;border-radius:12px;border:1px solid var(--ring);margin-bottom:8px;background:rgba(255,255,255,.02)}
.checks .row.done{background:rgba(52,211,153,.08);border-color:rgba(52,211,153,.35)}
input[type="checkbox"]{width:20px;height:20px}
.row .titleline{display:flex;align-items:center;justify-content:space-between;gap:10px}
.row .name{font-weight:800}
.row .dur{font-variant-numeric:tabular-nums;color:var(--sub)}
textarea,input[type="number"]{width:100%;background:transparent;border:1px solid var(--ring);color:var(--ink);
  border-radius:12px;padding:10px 12px;min-height:44px}
textarea{min-height:120px;resize:vertical}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.two{grid-template-columns:1fr}}
.bar{height:10px;border-radius:999px;background:var(--ring);overflow:hidden}
.bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.small{font-size:12px;color:var(--sub)}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:var(--ring);padding:2px 6px;border-radius:6px}
.footer{color:var(--sub);text-align:center;padding:20px 0}
.timer{font-variant-numeric:tabular-nums;font-weight:800}
.callout{border-left:4px solid var(--accent);padding:10px 12px;background:rgba(34,211,238,.09);border-radius:8px}
.okcall{border-left:4px solid var(--ok);background:rgba(52,211,153,.09)}
.danger{border-left:4px solid var(--bad);background:rgba(239,68,68,.09)}
.print-hint{display:block;margin-top:8px;color:var(--sub);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <div class="logo">NS</div>
      <div>
        <h1>NeuroStack — Weekly Brain Enhancement</h1>
        <div class="small">One-pass usefulness • iPhone-friendly • Offline-first (autosaves to your device)</div>
      </div>
    </div>
    <div class="nav" id="dayTabs"></div>
    <div class="controls">
      <button class="btn primary" id="expandAll">Expand all</button>
      <button class="btn" id="collapseAll">Collapse all</button>
      <button class="btn" id="printBtn">Print</button>
      <button class="btn ok" id="exportWeek">Export Weekly CSV</button>
      <button class="btn ghost" id="halfMode">Half‑Stack Mode: Off</button>
    </div>
  </div>
</header>

<main class="wrap">
  <article class="card">
    <h2>Overview</h2>
    <div class="meta">
      <p><span class="pill">Pillars</span> Focus control • Working memory & retrieval • Problem clarity • Creative throughput • Speed & accuracy • Stress regulation • Synthesis</p>
      <p><span class="pill">Always‑On Micro‑Habits</span> 20–30 min Zone‑2; hydrate; 5–10 min morning light; 2 min box breathing before blocks; anchor sleep.</p>
      <p class="small">Scoring (0–5): 0–1 no session • 2 partial no artifact • 3 full + artifact or metric • 4 full + artifact + metric + next step • 5 tangible transfer to real work.</p>
      <p class="small">Tip: Add this to Home Screen (iOS Safari → Share → Add to Home Screen) for single‑tap access. Data stays local via <span class="kbd">localStorage</span>.</p>
    </div>
  </article>

  <section id="days"></section>

  <div class="footer small">Built for fast reading, large tap targets, and on‑device saving. Print for a paper run sheet.</div>
</main>

<script>
// ---- Content ----
const DAYS = [
  {
    id:'mon', name:'Mon — Focus Calibration',
    objective:'Build on-demand focus; design your Focus Protocol v1.',
    outcome:'(1) Personal Focus SOP, (2) two 20‑min focus blocks with metrics, (3) distraction audit.',
    timer:[
      {t:5,  title:'Distraction audit + environment reset', tips:[
        'List your top 5 distraction triggers (internal/external).',
        'Physically remove 2 (close tab, move phone, shut door).'
      ]},
      {t:2,  title:'Breathing prep (box 4‑4‑4‑4)', tips:['Nose-only if possible; shoulders down; exhale fully.']},
      {t:20, title:'Focus Block #1 (single task)', tips:['Full-screen; notifications off; visible timer.']},
      {t:5,  title:'Micro-walk + water (no phone)', tips:['Reset posture; eyes distant for 30s.']},
      {t:20, title:'Focus Block #2 (same task or parallel)', tips:['Protect context; note one micro‑rule that helped.']},
      {t:8,  title:'Log metrics + write Focus SOP v1', tips:[
        'SOP: Trigger → Setup → Cues → Recover protocol.',
        'Metrics: start/end, # switches, depth 1–5, output.'
      ]},
      {t:5,  title:'Schedule tomorrow’s first block', tips:['Put a 25–45 min block on the calendar with the exact task line.']}
    ],
    exercises:[
      'Audit: internal (urge to check, anxiety) vs external (noise, people).',
      'SOP cues: playlist, closed door, phone in other room, timer visible, water poured.',
      'Recover: when attention slips, note it, stand 10s, resume at last visible subtask.'
    ],
    metrics:[
      'Depth (1–5), context switches, objective output (words/lines/problems). Goal tomorrow: +10% output with same time.'
    ],
    ifthen:[
      'If slips >3 → shorten blocks to 15 min & extend the walk to 7 min.',
      'If task feels vague → rewrite finish line to ≤10 words.'
    ]
  },
  {
    id:'tue', name:'Tue — Working Memory & Retrieval',
    objective:'Increase capacity and reduce forgetting.',
    outcome:'(1) 12 spaced flashcards, (2) 1 memory palace route (5 loci), (3) a 48‑hour review scheduled.',
    timer:[
      {t:5, title:'Choose content (facts, formulas, code patterns)', tips:['Pick what you’ll truly need this week.']},
      {t:10, title:'Create 12 atomic cards (Q ↔ A)', tips:['One fact per card; answer <20 words.']},
      {t:10, title:'Build a 5‑loci Memory Palace', tips:['Choose a familiar place with 5 distinct anchors.']},
      {t:15, title:'Encode 12 items into loci (vivid images)', tips:['Exaggerated, emotional, moving images.']},
      {t:10, title:'Retrieval practice (2 rounds, closed‑book)', tips:['Mark easy / hard / fail.']},
      {t:5, title:'Schedule spaced reviews (2d, 5d, 12d)', tips:['Put on calendar; morning blocks work best.']},
      {t:5, title:'Log transfer target', tips:['Where this knowledge helps this week.']}
    ],
    exercises:[
      'Peg alternative: 1=gun, 2=shoe, 3=tree, 4=door, 5=hive…',
      'Hard cards get a stronger image or are split into two cards.'
    ],
    metrics:['% correct per round; target ≥70% on round 2.'],
    ifthen:[
      'If round‑1 <50% → split complex cards and simplify language.',
      'If you can’t visualize loci → use peg list instead of palace.'
    ]
  },
  {
    id:'wed', name:'Wed — Clarity & Problem Solving',
    objective:'Cut through ambiguity and design a plan you can execute.',
    outcome:'(1) Problem Framing Sheet, (2) Decision Tree with If/Then rules, (3) First action scheduled.',
    timer:[
      {t:5, title:'Pick one real problem', tips:['One sentence; name the constraint (time/money/skill).']},
      {t:10, title:'Frame it (Goal, Current, Constraint, Evidence)', tips:['List 3 facts that must be true.']},
      {t:15, title:'Generate 5 options (force variety)', tips:['Include “do nothing”, “brute force”, “tiny slice”.']},
      {t:10, title:'Decision matrix (time/cost/reliability)', tips:['Score 1–5; pick weighted winner.']},
      {t:10, title:'If/Then tree + tripwire', tips:['Define stop‑and‑reassess triggers (e.g., >2h blocked).']},
      {t:5, title:'Commit first action on calendar', tips:['30–60 min starter; exact start time.']}
    ],
    exercises:[
      'Evidence filter: separate facts from assumptions; mark assumptions with “?” to test.',
      'Tripwire examples: spend cap reached, defect rate >3%, two failed outreach attempts.'
    ],
    metrics:['Choose one option and log the decisive factor (time, cost, or reliability).'],
    ifthen:[
      'If two options tie → choose the one with the fastest first signal.',
      'If still stuck → run a 15‑min half‑slice experiment today.'
    ]
  },
  {
    id:'thu', name:'Thu — Creative Throughput',
    objective:'Produce novel, useful options rapidly.',
    outcome:'(1) 10 raw ideas, (2) 1 named concept with a 60‑sec pitch, (3) micro‑prototype.',
    timer:[
      {t:3, title:'Define the problem in one line', tips:['Who, what, constraint.']},
      {t:12, title:'Diverge with SCAMPER (10 ideas)', tips:['Write visibly fast; no editing.']},
      {t:10, title:'Converge: score usefulness & ease', tips:['Pick top‑1 with a single reason.']},
      {t:15, title:'Micro‑prototype', tips:['Sketch/screenshot/20‑line snippet—smallest thing that proves it.']},
      {t:10, title:'Write a 60‑sec pitch + name it', tips:['If you can’t name it in 5 words, compress more.']},
      {t:5, title:'Log next test (who/when)', tips:['Commit a date to show someone.']}
    ],
    exercises:[
      'SCAMPER: Substitute, Combine, Adapt, Modify, Put to other use, Eliminate, Reverse.',
      'Proof beats description—one concrete example or image.'
    ],
    metrics:['Idea count (≥10), prototype exists (yes/no), clarity 1–5 (next‑day self‑score).'],
    ifthen:['If prototype takes >15 min → slice smaller until one screenshot proves the core.']
  },
  {
    id:'fri', name:'Fri — Processing Speed & Precision',
    objective:'Increase speed without trashing accuracy.',
    outcome:'(1) Two timed sprints, (2) Error pattern log, (3) Speed SOP.',
    timer:[
      {t:5, title:'Pick domain (math / typing / code / reading)', tips:['Use same material for both sprints.']},
      {t:10, title:'Sprint #1', tips:['All‑out focus; note discomfort level.']},
      {t:5, title:'Break + analyze errors', tips:['Classify: careless, knowledge gap, process flaw.']},
      {t:10, title:'Sprint #2 with one change', tips:['Change one variable only (chunking, font, posture).']},
      {t:10, title:'Update Speed SOP', tips:['Warm‑up, optimal block length, error checks.']},
      {t:5, title:'Record before/after metrics', tips:['Speed (WPM/problems/min) + error %.']}
    ],
    exercises:[
      'Math: 2‑digit × 2‑digit grid for 10 min.',
      'Typing: same passage twice.',
      'Reading: technical article; log WPM + three takeaways.'
    ],
    metrics:['Goal: error rate ≤3% while increasing speed by 10–20%.'],
    ifthen:[
      'If errors >5% → slow by 10% and add a mid‑block check.',
      'If gains stall → change exactly one variable next session.'
    ]
  },
  {
    id:'sat', name:'Sat — Stress, Stamina & Reset',
    objective:'Improve cognitive durability and recovery.',
    outcome:'(1) Breathing + gait protocol, (2) 20–30 min Zone‑2 session, (3) Shutdown routine checklist.',
    timer:[
      {t:5, title:'CO₂‑tolerance: 6‑3‑6‑3 breathing', tips:['Inhale‑hold‑exhale‑hold; stop if dizzy.']},
      {t:25, title:'Zone‑2 walk/cycle', tips:['You can talk in sentences; nose‑only if possible.']},
      {t:5, title:'Cold‑to‑warm shower contrast (optional)', tips:['1–2 cycles only if you tolerate it.']},
      {t:10, title:'Write Shutdown Routine', tips:['Last email check, tomorrow’s Top‑3, device off, stretch, book.']}
    ],
    exercises:[
      'If HR spikes or breath control slips, reduce pace until conversational.',
      'Place shutdown card by the bed as a visual cue.'
    ],
    metrics:['Perceived stress (1–5) pre/post, session minutes, sleep time planned.'],
    ifthen:[
      'If evenings drift → set a nightly “Shutdown” alarm.',
      'If poor sleep → front‑load recovery (food, light, earlier bedtime).'
    ]
  },
  {
    id:'sun', name:'Sun — Synthesis & Next Week’s Plan',
    objective:'Lock gains; choose the one thing that moves the needle next week.',
    outcome:'(1) Weekly review, (2) Top‑3 with first actions blocked, (3) Recovery plan for Mon.',
    timer:[
      {t:6, title:'Wins (5), Lessons (3)', tips:['Evidence‑based; what changed your mind?']},
      {t:6, title:'Blockers (3) + root cause guess', tips:['Constraint, not complaint.']},
      {t:8, title:'Choose Top‑3 for next week', tips:['Each has a first action that fits your calendar.']},
      {t:10, title:'Block first actions on calendar', tips:['Real time slots with alerts.']},
      {t:5, title:'Schedule recovery (sleep, food, movement)', tips:['One deliberate recovery activity today.']},
      {t:5, title:'Score the week + one tweak', tips:['0–5; what will you change?']}
    ],
    exercises:[
      'Use simple rubric: keep, start, stop.',
      'If a Top‑3 doesn’t fit the calendar, it isn’t a Top‑3 yet—slice thinner.'
    ],
    metrics:['All Top‑3 have dates/times. Week score 0–5.'],
    ifthen:['If energy is low → recovery before planning.']
  }
];

// ---- DOM Builders ----
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
function c(tag, attrs={}, children=[]){
  const el = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') el.className=v;
    else if(k.startsWith('on')) el.addEventListener(k.slice(2), v);
    else el.setAttribute(k,v);
  });
  children.forEach(ch=>{
    if(typeof ch==='string') el.appendChild(document.createTextNode(ch));
    else if(ch) el.appendChild(ch);
  });
  return el;
}

function ul(items){ const u=c('ul'); items.forEach(x=>u.appendChild(c('li',{},[x]))); return u; }

function buildDay(d){
  const sec = c('section', {class:'card day', id:'day_'+d.id}, []);
  sec.appendChild(c('h2', {}, [d.name]));
  const meta = c('div', {class:'meta'});
  meta.appendChild(c('p', {}, [c('span',{class:'pill'},['Objective']), ' ', d.objective]));
  meta.appendChild(c('p', {}, [c('span',{class:'pill'},['Outcome']), ' ', d.outcome]));
  sec.appendChild(meta);

  // Progress
  const bar = c('div', {class:'bar'}, [c('span',{id:`prog_${d.id}`},[])]);
  sec.appendChild(bar);

  // Timers & checks
  sec.appendChild(c('h3',{},['Timer Plan & Checkboxes']));
  const controls = c('div', {class:'controls'}, [
    c('button',{class:'btn primary',onClick:()=>startAutopilot(d.id)},['▶ Start Autopilot']),
    c('button',{class:'btn',onClick:()=>pauseTimers()},['⏸ Pause']),
    c('button',{class:'btn ghost',onClick:()=>resetTimers(d.id)},['↺ Reset']),
  ]);
  sec.appendChild(controls);

  const checks = c('div',{class:'checks', id:`checks_${d.id}`});
  d.timer.forEach((step, idx)=>{
    const row = c('div',{class:'row'});
    const cb = c('input',{type:'checkbox','data-idx':idx});
    cb.addEventListener('change',()=>{ row.classList.toggle('done', cb.checked); saveDay(d.id); updateProgress(d.id); });
    const info = c('div',{},[
      c('div',{class:'titleline'},[
        c('div',{class:'name'},[`${idx+1}. ${step.title}`]),
        c('div',{class:'dur'},[c('span',{class:'timer',id:`t_${d.id}_${idx}`},[` ${String(step.t).padStart(2,'0')}:00 `])])
      ]),
      c('div',{class:'small'},[step.tips.join(' • ')])
    ]);
    const buttons = c('div',{class:'controls'},[
      c('button',{class:'btn',onClick:()=>startTimer(d.id,idx)},['Start']),
      c('button',{class:'btn ghost',onClick:()=>stopTimer()},['Stop'])
    ]);
    row.appendChild(cb); row.appendChild(info); row.appendChild(buttons);
    checks.appendChild(row);
  });
  sec.appendChild(checks);

  // Notes + score
  const two = c('div',{class:'two'},[]);
  const notes = c('div',{},[c('h3',{},['Notes']), c('textarea',{id:`notes_${d.id}`,placeholder:'Key wins, gaps, tweaks…'})]);
  const score = c('div',{},[
    c('h3',{},['Score (0–5)']),
    c('input',{type:'number',min:'0',max:'5',step:'1',id:`score_${d.id}`,placeholder:'0–5'}),
    c('div',{class:'controls'},[
      c('button',{class:'btn ok',onClick:()=>exportDay(d.id)},['Export Day Log']),
      c('button',{class:'btn',onClick:()=>printPage()},['Print Day']),
      c('button',{class:'btn warn',onClick:()=>clearDay(d.id)},['Clear Day Data'])
    ]),
    c('span',{class:'print-hint'},['Rubric: 0–1 none • 2 partial • 3 full+artifact/metric • 4 full+artifact+metric+next • 5 transfer'])
  ]);
  two.appendChild(notes); two.appendChild(score);
  sec.appendChild(two);

  // Clarifications etc.
  function panel(title, arr, extraClass=''){
    const det = c('details',{open:'',class:'details'},[]);
    det.appendChild(c('summary',{},[c('strong',{},[title])]));
    det.appendChild(c('div',{class:`details-pane ${extraClass}`},[ul(arr)]));
    return det;
  }
  sec.appendChild(panel('Exercises (how to do it)', d.exercises,'callout'));
  sec.appendChild(panel('Metrics (track today)', d.metrics,''));
  sec.appendChild(panel('If / Then', d.ifthen,'okcall'));

  return sec;
}

// ---- State / Storage ----
const state = { running:null, remaining:0, day:null, autopilot:false, half:false, tick:null };

function saveDay(dayId){
  const rows = $$(`#checks_${dayId} .row input[type=checkbox]`).map(x=>x.checked);
  const notes = $(`#notes_${dayId}`).value;
  const score = $(`#score_${dayId}`).value;
  const payload = {checks:rows, notes, score};
  localStorage.setItem('ns_day_'+dayId, JSON.stringify(payload));
}

function loadDay(dayId){
  try{
    const payload = JSON.parse(localStorage.getItem('ns_day_'+dayId) || '{}');
    const checks = payload.checks || [];
    $$('#checks_'+dayId+' .row input[type=checkbox]').forEach((el,i)=>{ el.checked = !!checks[i]; el.closest('.row').classList.toggle('done', el.checked); });
    $(`#notes_${dayId}`).value = payload.notes || '';
    $(`#score_${dayId}`).value = payload.score || '';
    updateProgress(dayId);
  }catch(e){}
}

function updateProgress(dayId){
  const boxes = $$('#checks_'+dayId+' .row input[type=checkbox]');
  const done = boxes.filter(b=>b.checked).length;
  $(`#prog_${dayId}`).style.width = (boxes.length? (100*done/boxes.length) : 0)+'%';
}

// ---- Timers ----
function fmt(s){ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function beep(){ try{ const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ac.destination); o.start(); g.gain.setValueAtTime(0.0001,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.3,ac.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+0.35); o.stop(ac.currentTime+0.4);}catch(e){} }
function stepDuration(dayId, idx){
  const raw = DAYS.find(d=>d.id===dayId).timer[idx].t;
  return (state.half? Math.max(1, Math.round(raw*0.5)) : raw)*60;
}

function startTimer(dayId, idx){
  stopTimer();
  state.day = dayId; state.running = idx; state.remaining = stepDuration(dayId, idx);
  tick();
}

function startAutopilot(dayId){
  state.autopilot = true; startTimer(dayId, 0);
}

function pauseTimers(){
  if(state.tick){ clearTimeout(state.tick); state.tick=null; }
  else tick();
}

function resetTimers(dayId){
  stopTimer();
  const d = DAYS.find(x=>x.id===dayId);
  d.timer.forEach((s,i)=>{ const el = document.getElementById(`t_${dayId}_${i}`); if(el){ const mm = String(state.half? Math.max(1,Math.round(s.t*0.5)) : s.t).padStart(2,'0'); el.textContent = ` ${mm}:00 `; } });
}

function stopTimer(){
  if(state.tick){ clearTimeout(state.tick); state.tick=null; }
  state.running=null; state.remaining=0; state.autopilot=false;
}

function tick(){
  if(state.running===null) return;
  const id = `t_${state.day}_${state.running}`;
  const el = document.getElementById(id); if(!el){ stopTimer(); return; }
  el.textContent = ' '+fmt(state.remaining)+' ';
  if(state.remaining<=0){
    beep();
    // mark complete
    const box = document.querySelector(`#checks_${state.day} .row input[data-idx="${state.running}"]`);
    if(box){ box.checked = true; box.dispatchEvent(new Event('change')); }
    if(state.autopilot){
      const next = state.running+1;
      const d = DAYS.find(x=>x.id===state.day);
      if(next<d.timer.length){ startTimer(state.day,next); return; }
      else { stopTimer(); return; }
    } else { stopTimer(); return; }
  }
  state.remaining -= 1;
  state.tick = setTimeout(tick, 1000);
}

// ---- Export / Print ----
function exportDay(dayId){
  const d = DAYS.find(x=>x.id===dayId);
  const checks = $$('#checks_'+dayId+' .row input[type=checkbox]').map((c,i)=>`${c.checked?'[x]':'[ ]'} ${i+1}. ${d.timer[i].title} (${d.timer[i].t}m)`);
  const notes = $(`#notes_${dayId}`).value;
  const score = $(`#score_${dayId}`).value;
  const text = [
    d.name, '',
    'Objective: '+d.objective,
    'Outcome: '+d.outcome, '',
    'Assignments:', ...checks, '',
    'Notes:', notes, '',
    'Score: '+score
  ].join('\n');
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = d.id+'_neurostack_log.txt'; a.click(); URL.revokeObjectURL(a.href);
}

function exportWeek(){
  const rows = ['day,step,title,minutes,done'];
  DAYS.forEach(d=>{
    const checks = $$('#checks_'+d.id+' .row input[type=checkbox]');
    d.timer.forEach((s,i)=>rows.push([d.id,i+1,'"'+s.title.replace(/"/g,'""')+'"', state.half? Math.max(1,Math.round(s.t*0.5)) : s.t, checks[i] && checks[i].checked ? 1 : 0].join(',')));
  });
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = 'neurostack_week.csv'; a.click(); URL.revokeObjectURL(a.href);
}

function printPage(){ window.print(); }

function clearDay(dayId){
  if(!confirm('Clear checkboxes, notes, and score for this day?')) return;
  $$('#checks_'+dayId+' .row input[type=checkbox]').forEach(x=>x.checked=false);
  $(`#notes_${dayId}`).value=''; $(`#score_${dayId}`).value='';
  updateProgress(dayId); saveDay(dayId);
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', ()=>{
  // Build nav
  const tabs = $('#dayTabs');
  const navItems = [{id:'ov', label:'Overview'}, ...DAYS.map(d=>({id:d.id, label:d.name.split('—')[0].trim()}))];
  navItems.forEach((n, i)=>{
    const b = c('button',{class:(i===0?'active':''),onClick:()=>{
      $$('#dayTabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      if(n.id==='ov'){ window.scrollTo({top:0,behavior:'smooth'}); return; }
      document.getElementById('day_'+n.id).scrollIntoView({behavior:'smooth',block:'start'});
    }},[n.label]);
    tabs.appendChild(b);
  });

  // Build days
  const daysRoot = document.getElementById('days');
  DAYS.forEach(d=>{
    const sec = buildDay(d);
    daysRoot.appendChild(sec);
    loadDay(d.id);
  });

  // Header controls
  document.getElementById('expandAll').addEventListener('click', ()=>$$('details').forEach(d=>d.open=true));
  document.getElementById('collapseAll').addEventListener('click', ()=>$$('details').forEach(d=>d.open=false));
  document.getElementById('printBtn').addEventListener('click', printPage);
  document.getElementById('exportWeek').addEventListener('click', exportWeek);
  document.getElementById('halfMode').addEventListener('click', (e)=>{
    state.half = !state.half; e.target.textContent = 'Half‑Stack Mode: '+(state.half?'On':'Off');
    // refresh durations
    DAYS.forEach(d=>resetTimers(d.id));
  });
});
</script>

<script>
// Minimal PWA registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>

</body>
</html>
